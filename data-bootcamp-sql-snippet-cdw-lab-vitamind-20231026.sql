/*Vitamin D patientlabchem code for va data bootcamp lab presentation 20231026*/
/*Last updated 20231019 by Vilija Joyce - vilija.joyce@va.gov*/

-- Clear temp tables (if they exist)
drop table if exists #labnamesids

-- Use cipher code to a create a list of vitamin D lab test sids and names from dim.labchemtest
select distinct
		labchemtestsid
		,sta3n
		,labchemtestname
	into #labnamesids
	from cdwwork.dim.labchemtest
	where 
	labchemtestsid in (1400004183, 1400066241, 1000021952, 1200070298, 800011977, 800015318, 800009642, 1000032826, 1000083337, 1200059214, 1000095629, 1000077639, 1000111250, 1000038708, 1000086710, 1000111249, 1000024370, 1000095305, 1000111248, 1000015555, 1000085589, 1000079363, 1000085177, 1000094244, 1000082424, 1000081575, 1000083253, 1000070483, 1000030676, 1000061448, 1000073325, 1200023603, 800220273, 1000072488, 800060324, 1200017600, 1000008553, 1200013148, 800084683, 1400046584, 800073168, 800082916, 800004624, 1400057972, 1200025488, 800062804, 1200019057, 1400040006, 800219013, 1400040958, 1400012340, 1000015456, 1000087534, 800007660, 1000080467, 800044848, 1200018853, 800079768, 1400039313, 1400013453, 1200004502, 800058027, 1400009984, 1200019788, 1400043561, 1000010384, 1400015865, 1200027432, 1200024930, 1400069905, 1200040857, 800009020, 1400000381, 1000014368, 800006332, 1400076101, 800033780, 1000050256, 1200078628, 1000129814, 1000055564, 1000123221, 1000129820, 1000123222, 1000027257, 1000129834, 1000123223, 1000062097, 1000129835, 1000113172, 1400066339, 1200080013, 1200078474, 1400077661, 800224505, 1400063335, 1000090828, 800221986, 1000112988, 800033093, 1400049621, 800034354, 800243422, 1200119512, 800233217, 1000111247, 1200112543, 1000048752, 800221979, 1400582836, 800231796, 800078855, 800005025, 1000102061, 1000098390, 1000080650, 1000093278, 1000089217, 1000079845, 800037810, 800011978, 1000087823, 1000108353, 800078735, 1400041286, 1200052364, 1200075881, 800033200, 1400052534, 1000105656, 1200039268, 1400566562, 1200111432, 1200116464, 1400039516, 800056354, 800075865, 1200119260, 800001481, 1200097580, 1200128499, 1000011199, 1400051944, 1200000760, 800224220, 1400566954, 1000103658, 800247957, 1000114602, 1200122609, 1200018490, 800073007, 1200122861, 1200138163, 800038018, 1200125601, 1200112095, 800090070, 1200114152, 1400579774, 1000082923, 1000103298, 1400078462, 1400010072, 800222336, 1000037448, 1000106465, 1000063050, 1400570084, 1400572465, 1400571447, 800044412, 800229607, 1000110133, 1400026368, 1000103364, 1000103342, 1000103349, 1000053382, 1000103376, 800222137, 800222138, 1200011940, 1200036871, 1200105373, 1200071008, 1200103801, 1200015535, 1200023345, 1000026451, 1200052071, 1200116045, 1000035422, 1400566786, 1400046643, 1000105481, 1000011468, 1000044732, 1400033286, 1000001782, 800222139, 800222136, 1000063065, 1000001753, 1000001752, 1000105542, 1000081543, 1000109179, 1200116018, 1200116017, 1400075108, 800047009, 1200116016, 1400581268, 1400079213, 1200115906, 1000056170, 1200052247, 800248251, 800090578, 1000087661, 1400566744, 800024852, 1200117564, 1400575859, 1000109326, 800078734, 800232571, 1400567187, 1400566743, 800230269, 1200085230, 1000024417, 800089646, 1400037087, 800018446, 800088618, 1200116595, 1000090199, 800027235, 1200078801, 800062090, 800000608, 800000406, 1200077066, 800064972, 800022705, 1200068873, 800066356, 800020869, 800023823, 1000099724, 1000039097, 1400000081, 1200018091, 1200069876, 1200027105, 1200000395, 1400021365, 1200115219, 1000000151, 800031510, 800002900, 1000004290, 1200146908, 1400577185, 1000103291, 800089982, 1400037213, 1200101081, 1000028227, 1200013916, 800010267, 1200002403, 800235340, 800003021, 800033052, 1400075826, 1000112737, 800079228, 1200034542, 1000089660, 800002617, 1200092523, 1200085774, 800016245, 1000036863, 1000055613, 800057687, 800012708, 800227500, 1200102678, 1200099345, 1200049087, 1000027096, 1200074042, 1400004566, 1200124465, 800243615, 1200125435, 800004719, 1400000735, 1400001378, 1400562498, 1200099271, 1200098083, 1000099396, 1000050126, 800055172, 1200000015, 800055643, 800064393, 800234734, 1400050213, 1000093029, 1200105627, 800225957, 1400039601, 800038017, 1400063233, 800013204, 1200102562, 1200117735, 1200112983, 1200079499, 1000042869, 1200077437, 800090614, 800243625, 1400003835, 1200117932, 1200123473, 1000051627, 1400063040, 1000081083, 1200103509, 800225958, 1400038980, 800039083, 1000095297, 1400000522, 800012871, 1200103262, 1200117736, 1200112894, 1200071446, 1000053765, 1200070162, 800090613, 800243627, 1400002542, 1200117931, 1200123472, 1000056297, 1000031495, 1400017778, 1200076825, 800063643, 1400020976, 1200044405, 800223803, 1000095841, 1200117734, 1200103364, 1200092708, 1200074574, 800090612, 800012869, 1000033422, 1400002694, 1000095251, 1200117930, 1200123471, 1000032950, 1000009113, 800240152, 800053680, 1200111456, 800054749, 1200112857, 1200111862, 800239792, 1000033751, 800086273, 800008508, 1000000356, 1000083886, 800041418, 1400010196, 800249982, 800225360, 1000030925, 1200069269, 800034550, 1400575099, 1200082199, 1200083481, 1200089496, 1200084929, 1000010893, 1000059558, 1000094436, 1000010892, 1000129864, 800243626, 1200063637, 800051464, 800055860, 1200115911, 800054294, 800047010, 1200148524, 1200070289, 1200063478, 800054061, 800057978, 800047812, 800053397, 1200148525, 1200080675, 1200046820, 1400562207, 800052389, 800055859, 800056280, 1200148526, 1200014699, 1200135673, 1200130381, 1400073924, 1000017931, 1000021648, 800228246, 1400033444, 1000078781, 1200131423, 1200078233, 1200114150, 1400048146, 1000001267, 1000075078, 1000105767, 1200132275, 1400040506, 1400060221, 1200025523, 1400579429, 1200000343, 1000039160, 1400036483, 1400012721, 1200123446, 800222310, 800056281, 1000020756, 800028167, 800022438, 800022207, 1000055819, 1000065969, 1200077700, 1000051616, 1000112976, 1200077828, 1200078644, 1000054121, 1200117933, 1000089627, 1000005535, 800135978, 800135979, 1000114415, 1000069261, 1400078713, 800021813, 1000054446, 1200129895, 1200107994, 1200063018, 1000038174, 800224223, 800089780, 800080349, 800069335, 800070372, 800067549, 800067764, 800052390, 1400069463, 800080651, 800007989, 800026704, 800017572, 800017389, 800023425, 800022194, 800022193, 1000013394, 1200028253, 1200038057, 800027786, 1200015127, 800036249, 1400058654, 1200028529, 1400057155, 1200013525, 1200026357, 1200009970, 1000067139, 1400076020, 1400061143, 800037987, 1200021544, 800056484, 800048349, 1200020738, 1000067906, 1200054185, 1200123474, 1000048990, 800054112, 1200113572, 1200055901, 800071892, 800028329, 1200048015, 800031751, 800037619, 1400026317, 1200068609, 1400022120, 1400066098, 1200095426, 1000025206, 1000042606, 1200053139, 1000008917, 1200007589, 1200113014, 1200075985, 800034377, 1200021988, 800013928, 1200075278, 1400027905, 1200117737, 800249395, 800243247, 1000091356, 800070639, 800051726, 1000093489, 800054638, 1000035085, 800047396, 800225969, 1000016196, 1000013485, 1000058056, 800053839, 1200112440, 1000100346, 1400027536, 1400035292, 1400579697, 1400078107, 1000118723, 1000118722, 1000118721, 1400024684, 1000037328, 1400048472, 1400055708, 1200083513, 1200112441, 800043500, 1000012564, 1000005326, 1000016419
	)
-- n=580

-- Review
select top 100 * from #labnamesids

-- Clear temp tables (if they exist)
drop table if exists #labs1

-- Use list of lab names and sids to pull September 2023 vitamin D tests from chem.patientlabchem 
select	
	 pl.patientsid
	,pl.sta3n 
	,pl.labchemcompletedatetime
	,pl.labchemtestsid
	,ln.labchemtestname
	,pl.loincsid
	,lo.loinc
	,pl.labchemresultvalue
	,pl.labchemresultnumericvalue
	,pl.units
	,pl.labpanelsid
	,lp.labpanelcomment
into #labs1
from cdwwork.chem.patientlabchem as pl
inner join
	#labnamesids ln on pl.labchemtestsid=ln.labchemtestsid and pl.sta3n=ln.sta3n
left join 
	cdwwork.dim.loinc lo on pl.loincsid=lo.loincsid
left join 
	cdwwork.chem.labpanel lp on pl.labpanelsid=lp.labpanelsid
	where
		(
		pl.labchemcompletedatetime >= convert (datetime2(0), '9/1/2023') and
		pl.labchemcompletedatetime <= convert (datetime2(0), '9/30/2023')
		)
-- n=213893
		
-- Review
select top 100 * from #labs1 order by patientsid, labchemcompletedatetime

-- Use list of lab names and sids to create a unique list of vitamin D-related loincs 
drop table if exists #loincs
select distinct loincsid, loinc, sta3n into #loincs from #labs1 where loinc not in ('*missing*')

-- Review
select top 100 * from #loincs
-- n=126

-- Use list of loincs to pull September 2023 vitamin D tests from chem.patientlabchem 
drop table if exists #labs2
select	
	 pl.patientsid
	,pl.sta3n 
	,pl.labchemcompletedatetime
	,pl.labchemtestsid
	,lc.labchemtestname
	,pl.loincsid
	,lo.loinc
	,pl.labchemresultvalue
	,pl.labchemresultnumericvalue
	,pl.units
	,pl.labpanelsid
	,lp.labpanelcomment
into #labs2
from cdwwork.chem.patientlabchem pl
inner join
	#loincs lo on pl.loincsid=lo.loincsid and pl.sta3n=lo.sta3n
  left join 
	cdwwork.dim.labchemtest lc on pl.labchemtestsid=lc.labchemtestsid
  left join 
	cdwwork.chem.labpanel lp on pl.labpanelsid=lp.labpanelsid
	where
		(
		pl.labchemcompletedatetime >= convert (datetime2(0), '9/1/2023') and
		pl.labchemcompletedatetime <= convert (datetime2(0), '9/30/2023') 
		)			
-- n=214213

-- Review
select top 100 * from #labs2 order by patientsid, labchemcompletedatetime

-- Merge tables. Keep unique records only.
select patientsid, sta3n, labchemcompletedatetime, labchemtestsid, loinc, labchemtestname, labchemresultvalue, units, labpanelcomment
into #labsfinal
from #labs1 
union 
select patientsid, sta3n, labchemcompletedatetime, labchemtestsid, loinc, labchemtestname, labchemresultvalue, units, labpanelcomment 
from #labs2 
-- n= 217797

-- Review
select top 100 * from #labsfinal order by patientsid, labchemcompletedatetime
